# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main  # - main to trigger on commits to main branch

pool:
  vmImage: "windows-latest"

# Working Directory
variables:
  ENVIRONMENT: dev
  azureprojectname: "PeikkoPrecastWallDesigner" #this is the name of the project in azure
  projFileName: "PeikkoPrecastWallDesigner.Api/PeikkoPrecastWallDesigner.Api.csproj" #Add project .csproj file name here
  projectName: "pwd-backend" #add project name here
  workingDirectory: "$(System.DefaultWorkingDirectory)/$(projectName)/src" #change project name according to folder structure
  buildConfiguration: "Release"
  name: $(Date:yyyyMMdd)$(Rev:.r)
  resourceGroupName: "$(azureProjectName)-$(ENVIRONMENT)-rg"
  webAppName: "$(azureProjectName)-$(ENVIRONMENT)-webapp"

steps:
  - script: dir "$(workingDirectory)"
    displayName: "List files in $(workingDirectory)"

  # Restore NuGet Packages
  - task: UseDotNet@2
    displayName: 'Install .NET SDK 9'
    inputs:
      packageType: 'sdk'
      version: '9.x'
      installationPath: $(Agent.ToolsDirectory)/dotnet
      arguments: "--verbosity detailed"
      includePreviewVersions: true

  - task: DotNetCoreCLI@2
    displayName: "dotnet restore"
    inputs:
      command: "restore"
      projects: "**/*.csproj"
      feedsToUse: "select"
    #   vstsFeed: "90811742-70fc-48cf-a2c2-ae26d6e63ac6"

  # Build All Projects
  - task: DotNetCoreCLI@2
    displayName: "Build All Projects"
    inputs:
      command: "build"
      projects: "**/*.csproj"
      arguments: "--configuration $(buildConfiguration)"

  # Publish Api project
  - task: DotNetCoreCLI@2
    inputs:
      displayName: "Publish"
      command: "publish"
      publishWebProjects: false
      projects: "$(workingDirectory)/$(projFileName)"
      arguments: "--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/$(azureprojectname)_$(ENVIRONMENT)_$(Build.BuildNumber) --verbosity detailed --no-restore"

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)/$(azureprojectname)_$(ENVIRONMENT)_$(Build.BuildNumber)"
      ArtifactName: "$(azureprojectname)_LatestBuild"
      publishLocation: "Container"

  - task: AzureRmWebAppDeployment@4
    inputs:
      ConnectionType: "AzureRM"
      azureSubscription: "Peikko Services Azure Connection"
      enableCustomDeployment: true
      DeploymentType: "zipDeploy"
      appType: "webApp"
      WebAppName: "$(webAppName)"
      packageForLinux: "$(Build.ArtifactStagingDirectory)/**/*.zip"

