trigger:
  - main  # Trigger pipeline on commits to the main branch

pool:
  vmImage: "windows-latest"

variables:
  ENVIRONMENT: dev
  azureProjectName: "pwd-backend"  # Azure project name
  projFileName: "PeikkoPrecastWallDesigner.Api/PeikkoPrecastWallDesigner.Api.csproj"  # Project .csproj file path
  testProjFileName: "PeikkoPrecastWallDesigner.UnitTests/PeikkoPrecastWallDesigner.UnitTests.csproj"  # Unit test project path
  workingDirectory: "$(System.DefaultWorkingDirectory)/src"  # Source directory
  buildConfiguration: "Release"
  resourceGroupName: "$(azureProjectName)-$(ENVIRONMENT)-rg"
  webAppName: "$(azureProjectName)-$(ENVIRONMENT)-webapp"

stages:
- stage: Initialize
  displayName: Initialization
  jobs:
  - job: ListFiles
    displayName: List Working Directory
    steps:
    - script: dir "$(System.DefaultWorkingDirectory)"
      displayName: "List files in working directory"
  - job: InstallDotNet
    displayName: Install .NET SDK
    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET SDK 9'
      inputs:
        packageType: 'sdk'
        version: '9.x'
        installationPath: $(Agent.ToolsDirectory)/dotnet
        arguments: "--verbosity detailed"
        includePreviewVersions: true

- stage: Restore
  displayName: Restore Packages
  jobs:
  - job: RestorePackages
    displayName: Restore NuGet Packages
    steps:
    - task: DotNetCoreCLI@2
      displayName: "dotnet restore"
      inputs:
        command: "restore"
        projects: "**/*.csproj"
        feedsToUse: "select"
        # vstsFeed: "90811742-70fc-48cf-a2c2-ae26d6e63ac6"  # Uncomment if using a specific feed

- stage: Build
  displayName: Build
  dependsOn: Restore
  jobs:
  - job: BuildProjects
    displayName: Build All Projects
    steps:
    - task: DotNetCoreCLI@2
      displayName: "Build All Projects"
      inputs:
        command: "build"
        projects: "**/*.csproj"
        arguments: "--configuration $(buildConfiguration)"

- stage: Test
  displayName: Test
  dependsOn: Build
  jobs:
  - job: RunTests
    displayName: Unit Tests
    steps:
    - task: DotNetCoreCLI@2
      displayName: "Run Unit Tests"
      inputs:
        command: "test"
        projects: "$(workingDirectory)/$(testProjFileName)"
        arguments: "--configuration $(buildConfiguration) --no-restore --logger:trx"

- stage: Publish
  displayName: Publish
  dependsOn: Test
  jobs:
  - job: PublishBackend
    displayName: Publish Backend Project
    steps:
    - task: DotNetCoreCLI@2
      displayName: "Publish"
      inputs:
        command: "publish"
        publishWebProjects: false
        projects: "$(workingDirectory)/$(projFileName)"
        arguments: "--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/$(azureProjectName)_$(ENVIRONMENT)_$(Build.BuildNumber) --verbosity detailed --no-restore"

    - task: PublishBuildArtifacts@1
      displayName: "Publish Build Artifacts"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)/$(azureProjectName)_$(ENVIRONMENT)_$(Build.BuildNumber)"
        ArtifactName: "$(azureProjectName)_LatestBuild"
        publishLocation: "Container"

- stage: Deploy
  displayName: Deploy to Azure WebApp
  dependsOn: Publish
  jobs:
  - deployment: DeployWebApp
    displayName: Deploy to Azure
    environment: "$(ENVIRONMENT)"
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureRmWebAppDeployment@4
            displayName: "Deploy to Azure WebApp"
            inputs:
              ConnectionType: "AzureRM"
              azureSubscription: "Peikko Services Azure Connection"
              enableCustomDeployment: true
              DeploymentType: "zipDeploy"
              appType: "webApp"
              WebAppName: "$(webAppName)"
              packageForLinux: "$(Build.ArtifactStagingDirectory)/**/*.zip"
              enableCustomApplicationSetting: true
              RemoveAdditionalFilesFlag: true
